name: Container Security

on:
  push:
    branches: [main, develop]
    paths:
      - 'apps/api/Dockerfile'
      - 'apps/api/**'
      - '.github/workflows/container-security.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'apps/api/Dockerfile'
      - 'apps/api/**'
      - '.github/workflows/container-security.yml'

permissions:
  contents: read
  security-events: write

env:
  DOCKERFILE_PATH: apps/api/Dockerfile
  IMAGE_NAME: meal-planning-api
  REGISTRY: ghcr.io

jobs:
  dockerfile-lint:
    name: Dockerfile ë¦°íŠ¸ ê²€ì‚¬
    runs-on: ubuntu-latest

    steps:
      - name: Checkout ì½”ë“œ
        uses: actions/checkout@v6

      - name: Hadolint ì‹¤í–‰
        uses: hadolint/hadolint-action@v3.3.0
        with:
          dockerfile: ${{ env.DOCKERFILE_PATH }}
          format: sarif
          output-file: hadolint-results.sarif
          no-fail: true

      - name: Hadolint ê²°ê³¼ ì—…ë¡œë“œ
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: hadolint-results.sarif
          category: dockerfile-lint

      - name: Hadolint ìš”ì•½ ì¶œë ¥
        uses: hadolint/hadolint-action@v3.3.0
        with:
          dockerfile: ${{ env.DOCKERFILE_PATH }}
          format: tty
          no-fail: true

  container-scan:
    name: ì»¨í…Œì´ë„ˆ ì·¨ì•½ì  ìŠ¤ìº”
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout ì½”ë“œ
        uses: actions/checkout@v6

      - name: Docker Buildx ì„¤ì •
        uses: docker/setup-buildx-action@v3.7.1

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ
        uses: docker/build-push-action@v6
        with:
          context: ./apps/api
          file: ${{ env.DOCKERFILE_PATH }}
          tags: ${{ env.IMAGE_NAME }}:${{ github.sha }}
          load: true
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Grype ì·¨ì•½ì  ìŠ¤ìº”
        uses: anchore/scan-action@v7.3.2
        id: scan
        with:
          image: ${{ env.IMAGE_NAME }}:${{ github.sha }}
          fail-build: false
          severity-cutoff: critical
          output-format: sarif

      - name: ì·¨ì•½ì  ìŠ¤ìº” ê²°ê³¼ ì—…ë¡œë“œ
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: ${{ steps.scan.outputs.sarif }}
          category: container-vulnerabilities

      - name: Grype ìƒì„¸ ë¦¬í¬íŠ¸ ìƒì„±
        uses: anchore/scan-action@v7.3.2
        if: always()
        with:
          image: ${{ env.IMAGE_NAME }}:${{ github.sha }}
          fail-build: false
          output-format: table

  build-test:
    name: Docker ë¹Œë“œ ë° ì‹œì‘ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest

    steps:
      - name: Checkout ì½”ë“œ
        uses: actions/checkout@v6

      - name: Docker Buildx ì„¤ì •
        uses: docker/setup-buildx-action@v3.7.1

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ
        uses: docker/build-push-action@v6
        with:
          context: ./apps/api
          file: ${{ env.DOCKERFILE_PATH }}
          tags: ${{ env.IMAGE_NAME }}:test
          load: true
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILDKIT_CONTEXT_KEEP_GIT_DIR=1

      - name: ì»¨í…Œì´ë„ˆ ì‹œì‘ í…ŒìŠ¤íŠ¸
        run: |
          # í…ŒìŠ¤íŠ¸ìš© í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„±
          cat > .env.test << EOF
          DATABASE_URL=postgresql://postgres:postgres@localhost:5432/mealplanning_test
          JWT_SECRET_KEY=test-secret-key-for-ci-only-do-not-use-in-production
          REDIS_URL=redis://localhost:6379/0
          APP_ENV=development
          EOF

          # PostgreSQL ì„œë¹„ìŠ¤ ì‹œì‘ (í—¬ìŠ¤ì²´í¬ìš©)
          docker run -d \
            --name postgres-test \
            -e POSTGRES_PASSWORD=postgres \
            -e POSTGRES_DB=mealplanning_test \
            -p 5432:5432 \
            --health-cmd="pg_isready -U postgres" \
            --health-interval=5s \
            --health-timeout=5s \
            --health-retries=5 \
            postgres:16-alpine

          # Redis ì„œë¹„ìŠ¤ ì‹œì‘
          docker run -d \
            --name redis-test \
            -p 6379:6379 \
            redis:7-alpine

          # ì„œë¹„ìŠ¤ ì¤€ë¹„ ëŒ€ê¸°
          echo "ë°ì´í„°ë² ì´ìŠ¤ ì¤€ë¹„ ëŒ€ê¸° ì¤‘..."
          timeout 30s bash -c 'until docker exec postgres-test pg_isready -U postgres; do sleep 1; done'

          echo "Redis ì¤€ë¹„ ëŒ€ê¸° ì¤‘..."
          sleep 5

          # API ì»¨í…Œì´ë„ˆ ì‹œì‘
          docker run -d \
            --name api-test \
            --env-file .env.test \
            --network host \
            ${{ env.IMAGE_NAME }}:test

          # ì»¨í…Œì´ë„ˆ ì‹œì‘ ëŒ€ê¸° ë° í—¬ìŠ¤ì²´í¬
          echo "API ì„œë²„ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
          sleep 10

          # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
          docker ps -a

          # ë¡œê·¸ í™•ì¸
          echo "=== API ì»¨í…Œì´ë„ˆ ë¡œê·¸ ==="
          docker logs api-test

          # í—¬ìŠ¤ì²´í¬ (ì•±ì´ 8080 í¬íŠ¸ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸)
          echo "=== í—¬ìŠ¤ì²´í¬ ==="
          max_attempts=30
          attempt=0
          while [ $attempt -lt $max_attempts ]; do
            if curl -f http://localhost:8080/health 2>/dev/null; then
              echo "âœ… API ì„œë²„ê°€ ì •ìƒì ìœ¼ë¡œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤"
              exit 0
            fi
            attempt=$((attempt + 1))
            echo "í—¬ìŠ¤ì²´í¬ ì‹œë„ $attempt/$max_attempts..."
            sleep 2
          done

          echo "âŒ API ì„œë²„ ì‹œì‘ ì‹¤íŒ¨"
          docker logs api-test
          exit 1

      - name: ì»¨í…Œì´ë„ˆ ì •ë¦¬
        if: always()
        run: |
          docker stop api-test postgres-test redis-test || true
          docker rm api-test postgres-test redis-test || true

  security-summary:
    name: ë³´ì•ˆ ìŠ¤ìº” ìš”ì•½
    runs-on: ubuntu-latest
    needs: [dockerfile-lint, container-scan, build-test]
    if: always()

    steps:
      - name: ìŠ¤ìº” ê²°ê³¼ ìš”ì•½
        run: |
          echo "## ğŸ”’ ì»¨í…Œì´ë„ˆ ë³´ì•ˆ ìŠ¤ìº” ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| ë‹¨ê³„ | ê²°ê³¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| Dockerfile ë¦°íŠ¸ | ${{ needs.dockerfile-lint.result == 'success' && 'âœ… í†µê³¼' || 'âŒ ì‹¤íŒ¨' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ì·¨ì•½ì  ìŠ¤ìº” | ${{ needs.container-scan.result == 'success' && 'âœ… í†µê³¼' || 'âŒ ì‹¤íŒ¨' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ë¹Œë“œ ë° ì‹œì‘ í…ŒìŠ¤íŠ¸ | ${{ needs.build-test.result == 'success' && 'âœ… í†µê³¼' || 'âŒ ì‹¤íŒ¨' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.dockerfile-lint.result }}" == "success" && \
                "${{ needs.container-scan.result }}" == "success" && \
                "${{ needs.build-test.result }}" == "success" ]]; then
            echo "### âœ… ëª¨ë“  ë³´ì•ˆ ê²€ì‚¬ í†µê³¼" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ì»¨í…Œì´ë„ˆê°€ ë³´ì•ˆ ê¸°ì¤€ì„ ì¶©ì¡±í•˜ë©° ì •ìƒì ìœ¼ë¡œ ì‹œì‘ë©ë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ ì¼ë¶€ ë³´ì•ˆ ê²€ì‚¬ ì‹¤íŒ¨" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Security íƒ­ì—ì„œ ìƒì„¸ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”." >> $GITHUB_STEP_SUMMARY
          fi

      - name: ì‹¤íŒ¨ ì‹œ ì›Œí¬í”Œë¡œìš° ì‹¤íŒ¨ ì²˜ë¦¬
        if: needs.dockerfile-lint.result != 'success' || needs.container-scan.result != 'success' || needs.build-test.result != 'success'
        run: |
          echo "::error::í•˜ë‚˜ ì´ìƒì˜ ë³´ì•ˆ ê²€ì‚¬ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤"
          exit 1
