name: Deploy API to Lightsail

on:
  push:
    branches: [main]
    paths:
      - 'apps/api/**'
      - 'docker-compose.prod.yml'
      - 'deploy/**'

  workflow_dispatch:  # 수동 실행 가능

jobs:
  deploy:
    name: Deploy to Lightsail
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.LIGHTSAIL_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.LIGHTSAIL_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

      - name: Deploy
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ secrets.LIGHTSAIL_USER }}@${{ secrets.LIGHTSAIL_HOST }} << 'DEPLOY'
          set -e

          cd ~/meal-planning

          # 코드 업데이트
          git pull origin main

          # 컨테이너 재빌드 & 재시작
          sudo docker compose -f docker-compose.prod.yml --env-file .env.prod up -d --build api

          # DB 마이그레이션 (있으면 적용)
          sudo docker exec meal-api alembic upgrade head || true

          # Nginx 재시작 (설정 변경 있을 수 있으니)
          sudo docker compose -f docker-compose.prod.yml --env-file .env.prod up -d nginx

          # 헬스체크
          sleep 5
          curl -sf https://meal-jw.duckdns.org/api/v1/health || exit 1

          echo "✅ Deploy complete!"
          DEPLOY

      - name: Cleanup old images
        if: success()
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ secrets.LIGHTSAIL_USER }}@${{ secrets.LIGHTSAIL_HOST }} \
            "sudo docker image prune -f"
