name: Security Scan

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  schedule:
    # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 9ì‹œ (KST ê¸°ì¤€)
    - cron: '0 0 * * 1'

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  secret-scan:
    name: ì‹œí¬ë¦¿ ìŠ¤ìº” (Gitleaks)
    runs-on: ubuntu-latest
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Gitleaks ìŠ¤ìº” ì‹¤í–‰
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_ENABLE_SUMMARY: true

      - name: Gitleaks ê²°ê³¼ ì—…ë¡œë“œ
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: gitleaks-report
          path: results.sarif
          retention-days: 30

  sast-python:
    name: SAST - Python (Bandit)
    runs-on: ubuntu-latest
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v6

      - name: Python ì„¤ì •
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: apps/api/requirements.txt

      - name: Bandit ì„¤ì¹˜
        run: |
          pip install bandit[sarif]==1.7.10

      - name: Bandit ìŠ¤ìº” ì‹¤í–‰
        run: |
          bandit -r apps/api/src \
            -f sarif \
            -o bandit-results.sarif \
            --severity-level medium \
            --exit-zero

      - name: Bandit SARIF ì—…ë¡œë“œ
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: bandit-results.sarif
          category: bandit

      - name: ì‹¬ê°ë„ í™•ì¸ ë° ì‹¤íŒ¨ ì²˜ë¦¬
        run: |
          # SARIF íŒŒì¼ì—ì„œ critical ë°œê²¬ ì‹œ ì‹¤íŒ¨ (highëŠ” ê²½ê³ ë§Œ)
          CRITICAL_COUNT=$(jq '[.runs[].results[] | select(.level == "error")] | length' bandit-results.sarif)
          HIGH_COUNT=$(jq '[.runs[].results[] | select(.level == "warning")] | length' bandit-results.sarif)

          echo "Critical issues: $CRITICAL_COUNT"
          echo "High issues: $HIGH_COUNT"

          if [ "$CRITICAL_COUNT" -gt 0 ]; then
            echo "âŒ Critical ë³´ì•ˆ ì´ìŠˆê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤."
            exit 1
          fi

  sast-javascript:
    name: SAST - JavaScript/TypeScript (Semgrep)
    runs-on: ubuntu-latest
    container:
      image: semgrep/semgrep
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v6

      - name: Semgrep ìŠ¤ìº” ì‹¤í–‰
        run: |
          semgrep scan \
            --config p/security-audit \
            --config p/owasp-top-ten \
            --config p/react \
            --config p/typescript \
            --config p/python \
            --sarif \
            --output semgrep.sarif \
            --error \
            . || true

      - name: Semgrep SARIF ì—…ë¡œë“œ
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: semgrep.sarif
          category: semgrep

  dependency-scan:
    name: ì˜ì¡´ì„± ìŠ¤ìº” (Trivy SCA)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target:
          - name: Python ì˜ì¡´ì„±
            path: apps/api
            type: python
          - name: Node.js ì˜ì¡´ì„±
            path: apps/web
            type: node
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v6

      - name: Trivy ìŠ¤ìº” ì‹¤í–‰ - ${{ matrix.target.name }}
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: 'fs'
          scan-ref: ${{ matrix.target.path }}
          format: 'sarif'
          output: 'trivy-${{ matrix.target.type }}-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          exit-code: '0'

      - name: Trivy SARIF ì—…ë¡œë“œ - ${{ matrix.target.name }}
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-${{ matrix.target.type }}-results.sarif'
          category: 'trivy-${{ matrix.target.type }}'

      - name: Trivy ìŠ¤ìº” ì‹¤í–‰ (í…Œì´ë¸” í˜•ì‹) - ${{ matrix.target.name }}
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: 'fs'
          scan-ref: ${{ matrix.target.path }}
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'

  summary:
    name: ë³´ì•ˆ ìŠ¤ìº” ìš”ì•½
    runs-on: ubuntu-latest
    needs: [secret-scan, sast-python, sast-javascript, dependency-scan]
    if: always()
    steps:
      - name: ìŠ¤ìº” ê²°ê³¼ ìš”ì•½
        run: |
          echo "## ðŸ”’ ë³´ì•ˆ ìŠ¤ìº” ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| ìŠ¤ìº” ìœ í˜• | ìƒíƒœ |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ì‹œí¬ë¦¿ ìŠ¤ìº” (Gitleaks) | ${{ needs.secret-scan.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SAST - Python (Bandit) | ${{ needs.sast-python.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SAST - JavaScript (Semgrep) | ${{ needs.sast-javascript.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ì˜ì¡´ì„± ìŠ¤ìº” (Trivy) | ${{ needs.dependency-scan.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ìƒì„¸ ê²°ê³¼ëŠ” Security íƒ­ì—ì„œ í™•ì¸í•˜ì„¸ìš”." >> $GITHUB_STEP_SUMMARY
